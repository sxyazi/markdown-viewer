<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Markdown Viewer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.1.4/dist/tailwind.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@2.10.0/github-markdown.min.css">
    <style>
        body {
            font-family: Roboto, sans-serif;
        }

        aside {
            min-width: 16px;
            max-width: 16px;
        }

        aside.fold {
            max-width: 16px;
            border-style: dashed;
        }

        aside.fold span {
            --tw-rotate: -90deg;
        }

        aside.fold h3, aside.fold ul {
            display: none;
        }

        aside.unfold {
            min-width: 300px;
            max-width: none;
            border-style: solid;
        }

        aside.unfold span {
            --tw-rotate: 90deg;
        }

        aside.unfold h3, aside.unfold ul {
            display: flex;
        }

        #files li::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 4px;
            background: rgba(107, 114, 128, var(--tw-text-opacity));
            border-radius: 2px;
            vertical-align: middle;
            margin-left: -10px;
            margin-right: 10px;
        }

        #files li.active {
            --tw-text-opacity: 1;
            color: rgba(16, 185, 129, var(--tw-text-opacity));
        }

        #files li.active::before {
            background: rgba(16, 185, 129, var(--tw-text-opacity));
        }

        #content li {
            list-style: inside;
        }

        #content li p {
            display: inline-block;
        }

        #content h1 {
            text-align: center;
            margin-bottom: 50px;
            border-bottom: none;
        }

        #content * + h1 {
            margin-top: 50px;
        }

        #content img {
            display: inline-block;
        }

        #content pre {
            border: 1px solid #eaecef;
        }

        #content .heading {
            position: relative;
        }

        #content .heading-anchor {
            visibility: hidden;
            position: absolute;
            transform: translate(-100%);
            padding-right: 3px;
            --tw-text-opacity: 1;
            color: rgba(16, 185, 129, var(--tw-text-opacity));
        }

        #content h1.heading .heading-anchor {
            display: none;
        }

        #content .heading:hover .heading-anchor {
            visibility: visible;
        }
    </style>
</head>
<body class="w-screen h-screen flex overflow-hidden">
<aside class="lg:w-1/6 h-full lg:max-w-none flex flex-col absolute lg:relative z-10 bg-white border-r border-dashed lg:border-solid border-gray-100">
    <h3 class="ml-7 mt-8 mb-5 hidden lg:flex font-bold text-2xl text-gray-600">Files</h3>
    <ul id="files" class="px-7 pb-7 hidden lg:flex flex-col text-sm overflow-auto text-gray-500"></ul>

    <span id="switch"
          class="w-5 h-5 absolute z-20 top-1/3 right-0 cursor-pointer transform duration-150 bg-white border rounded-full border-gray-100 translate-x-1/2 -rotate-90 lg:rotate-90 hover:scale-125">
       <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%">
           <path d="M548.864 679.8336a38.2464 38.2464 0 0 1-27.136 11.3664h-19.456a39.2192 39.2192 0 0 1-27.136-11.3664L212.3776 413.9008a26.0096 26.0096 0 0 1 0-36.7104l36.352-36.7616a24.9856 24.9856 0 0 1 35.84 0L512 570.6752l227.4304-230.2464a25.4976 25.4976 0 0 1 36.352 0l35.84 36.7616a26.0096 26.0096 0 0 1 0 36.7104l-262.7584 265.9328z"></path>
       </svg>
    </span>
</aside>

<section class="w-full relative flex flex-col items-stretch">
    <article id="content" class="px-12 md:px-14 lg:px-16 py-7 overflow-auto markdown-body"></article>
</section>
</body>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/contrib/auto-render.min.js"></script>

<script id="file-template" type="text/html">
    <li class="py-3 pl-6 cursor-pointer hover:text-green-500"></li>
</script>

<script>
    var allFiles = {}
    var currentFile = {}
    var fileTemplate = $('#file-template').html()

    function open(path, done) {
        if (!allFiles.list) {
            return done(false)
        }

        var file = null
        var isSwitch = false
        for (var i = 0; i < allFiles.list.length; i++) {
            if (path === allFiles.list[i].path) {
                file = allFiles.list[i]
                break
            }
        }

        if (!file) {
            return done(false)
        }

        isSwitch = file.path !== currentFile.path
        currentFile = file
        localStorage.setItem('recent:' + allFiles.root, file.path)

        scrollToFit()
        $('#files li').removeClass('active')
        $('#files li[path="' + file.path + '"]').addClass('active')
        if (file.path !== decodeURIComponent(location.pathname)) {
            history.pushState(null, '', file.path)
        }

        $.post('/file', {
            path: file.path
        }, function (html) {
            $('#content').html(html)
            isSwitch && $('#content').animate({scrollTop: 0}, 200)
            renderMathInElement($('#content').get(0), {
                delimiters: [
                    {left: "\\[", right: "\\]", display: true},
                    {left: "\\(", right: "\\)", display: false}
                ]
            })
            $('.heading[id="' + decodeURIComponent(location.hash.substr(1)) + '"] .heading-anchor').click()

            done && done(file)
        })
    }

    function openRecent(done) {
        var path
        if (/\.md$/.test(location.pathname)) {
            path = decodeURIComponent(location.pathname)
        } else {
            path = localStorage.getItem('recent:' + allFiles.root)
        }

        open(path, done)
    }

    function openReadme(done) {
        if (!allFiles.list) {
            return done(false)
        }

        var finds = []
        for (var i = 0; i < allFiles.list.length; i++) {
            if (allFiles.list[i].name.toLowerCase() === 'readme.md') {
                finds.push(allFiles.list[i].path)
            }
        }

        if (finds.length < 1) {
            return done(false)
        }

        finds.sort(function (a, b) {
            return a.length > b.length ? 1 : -1
        })

        open(finds.shift(), done)
    }

    function openFirst(done) {
        if (allFiles.list && allFiles.list.length > 0) {
            return open(allFiles.list[0].path, done)
        }

        return done(false)
    }

    function scrollToFit() {
        var filesElem = $('#files')
        var fileElem = filesElem.find('li[path="' + currentFile.path + '"]')
        var scrollTop = fileElem.offset().top - filesElem.offset().top + filesElem.scrollTop()

        if (scrollTop > filesElem.scrollTop() + filesElem.height()) {
            filesElem.animate({scrollTop: scrollTop}, 200)
        }
    }

    $.get('/files', function (files) {
        try {
            allFiles = JSON.parse(files)
        } catch (e) {
            allFiles = {}
        }

        for (var i = 0; i < allFiles.list.length; i++) {
            var file = $(fileTemplate)
            file.text(allFiles.list[i].name)
            file.attr('path', allFiles.list[i].path)
            file.attr('title', allFiles.list[i].path)

            $('#files').append(file)
        }

        (function openQueue(queue) {
            var fn = queue.shift()
            fn && fn(function (flag) {
                flag || openQueue(queue)
            })
        })([openRecent, openReadme, openFirst])
    })

    $('#switch').click(function () {
        var asideEle = $('aside')
        if (asideEle.width() >= 16) {
            asideEle.removeClass('unfold').addClass('fold')
        } else {
            asideEle.removeClass('fold').addClass('unfold')
        }
    })

    $('#files').on('click', 'li', function () {
        open($(this).attr('path'))
    })

    $('#content').on('click', '.heading-anchor', function () {
        var contentElem = $('#content')
        contentElem.animate({scrollTop: contentElem.scrollTop() + $(this).offset().top}, 200)

        var hash = '#' + decodeURIComponent($(this).parent().attr('id'))
        if (location.hash !== hash) {
            location.hash = hash
        }

        return false
    })

    $('#content').scroll(function () {
        var timer
        return function () {
            clearTimeout(timer)
            timer = setTimeout(function () {
                var contentElem = $('#content').get(0)
                var headingElems = $('#content .heading')
                if (contentElem.scrollTop === contentElem.scrollHeight - contentElem.offsetHeight) {
                    return history.pushState(null, '', currentFile.path + '#' + headingElems.last().attr('id'))
                }

                for (var i = 0, lastElem = headingElems.first(); i < headingElems.length; i++) {
                    if (headingElems.eq(i).position().top > 0) {
                        history.pushState(null, '', currentFile.path + '#' + lastElem.attr('id'))
                        break
                    }

                    lastElem = headingElems.eq(i)
                }
            }, 300)
        }
    }())

    window.addEventListener('popstate', function () {
        if (currentFile.path !== decodeURIComponent(location.pathname)) {
            openRecent()
        }
    })

    setTimeout(function watcher() {
        if (!currentFile.path) {
            return setTimeout(watcher, 500)
        }

        $.post('/stat', {
            path: currentFile.path
        }, function (stat) {
            try {
                stat = JSON.parse(stat)
            } catch (e) {
                stat = {}
            }

            if (stat.updated_at <= currentFile.updated_at) {
                return setTimeout(watcher, 500)
            }

            open(currentFile.path, function () {
                currentFile.updated_at = stat.updated_at
                setTimeout(watcher, 500)
            })
        })
    }, 500)
</script>
</html>